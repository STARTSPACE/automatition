# Коллекция скриптов автомазиции
Разработано   **[STARTSPACE - корпоративное облако приложений 1С, SQL & WEB] (https://www.startspace.ru)**</br>

*STARTSPACE - экспетры Amazon Web Services в России и странах СНГ*

Вашему вниманию представлена коллекция скриптов аввтоматизации запуска, остановки и перезапуска инстанций AWS.
Характерной особенностью данной коллекции является то, что мы принципиально создавали ее для использования без
внешних переменных, хранимых в отдельном файле или базе данных. Такое решение было продиковано желанием
обеспечить наших клиентов инструментом, не требующем дополнитеьных настроек. Все, что необходимо - это **правильно
выставить ключи тегов и соответствующие значения,** используя для этого собственную панель AWS, стороннеее решение
или AWS CLI язык.

Кроме этого, каждый из скриптов можно использовать как по отдельности, так и в составе предлагаемых групп.
# Описание технического решения
Архитектура технического решения выглядит следующим образом:
- папка ```start``` содержит скрипты для запуска инстанций
- папка ```stop``` содержит скрипты для остановки инстанций
- папка ```reboot``` содержит скрипты для перезапуска инстанций

Внутри каждой из папок есть дополнительные папки:
- ```ad``` - ALL DAYS - скрипты, которые запускаются ежедневно
- ```wd``` - WORK DAYS - скрипты, которые запускаются по рабочим дням (понедельник - пятница)

*Под РАБОЧИМИ ДНЯМИ подразумеваются обычные рабочие дни, без учета праздничных дней.*

Файл ```import-cron-jobs-full-list.sh``` содержит полный комплект расписаний для запуска всех необходимых заданий по запуску,
остановке и перезапуску инстанций. Расписание сформировано таким образом, что задания выполняются каждый час, например в 12.00,
13.00, 14.00 и т.д. Расписание покрывает полные сутки, 7 дней в неделю. Данный файл предназначен для импорта (см. ниже)
в предлагаемом или измененном виде.

# Порядок установки

**Предварительные действия**

В первую очередь необходимо создать права доступа, группу и технического пользователя.

**Шаг 1.** Для создания прав доступа необходимо войти в Панель управления AWS и средствами IAM (Identity and Access Management) создать Policy (меню слева Policies, кнопка Create policy, выбрать Create own policy и нажать на кнопку Select). В открывшееся окно вставить код, представленный ниже:
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ec2actionsforstartstopandreboot",
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeInstances",
                "ec2:StopInstances",
                "ec2:StartInstances",
                "ec2:RebootInstances"
            ],
            "Resource": "*"
        }
    ]
}
```
В поле Policy name внести имя, например ```ec2-actions```, сохранить документ, нажав кнопку Create policy

**Шаг 2.** Теперь создадим группу и прикрепим к ней только что созданные права. Для этого возвращаемся в IAM Dashboard (щелкнуть Dashboard слева вверху), выбираем Groups, Create New Group. В поле Group Name впишите название, например ```ec2-actions-all-instances```

На следующей странице в полученном списке прав выберите те права, которые создали на предыдущем шаге (для ускорения поиска можно возпользоваться полем поиска).

На следующей странице Вам будет представлена краткая сводка создаваемой группы, Вам необходимо подтвердить создание, нажав на кнопку Create Group.

**Шаг 3.** Теперь создаем технического пользователя. Возвращаемся в IAM Dashboard (щелкнуть Dashboard слева вверху), выбираем Users, нажимаем на кнопку Create New Users. Присваеваем имя, например ```ec2-actions-user``` и нажимаем кнопку Create. По окончанию процесса создания пользователя необходимо сохранить файл с учетными данными (ключ доступа и секретный ключ). Учетные данные НЕОБХОДИМОО СОХРАНИТЬ ЛОКАЛЬНО, так как скачать их в дальнейшем будет невозможно.

Возвращаемся в IAM Dashboard, выбираем Users и находим созданного пользователя. Открываем запись и нажимаем на кнопку Add User to Groups. В открывшемся окне выбираем только что созданную группу и нажимаем кнопку Add to Groups.

**На этом предварительные действия завершены**

*ВНИМАНИЕ! Порядок установки на RPM системы (Amazon Linux, CentOS и т.д.) будет уточнен позднее*

**Порядок установки на DEB системы**

*ВНИМАНИЕ! Данный порядок установки предполагает, что Вы настраиваете задания для инстаций из одного региона. Если Вам неообходимо управлять инстациями из разных регионов, то смотрите комментарии ниже*

Средствами AWS Console или AWS CLI создайте инстанцию с операционной системой Ubuntu 14.04 (LTS). Подключиться к ней можно с использованием PuTTY или MobaXterm. Более подробно можно почитать на портале документации AWS, [Connect to Your Instance] (http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-connect-to-instance-linux.html)

После подключения к консоли переключаемся по пользователя Root
```
$ sudo -s
```

Обновляем операционную систему и установленные утилиты
```
$ apt-get update && upgrade
```





